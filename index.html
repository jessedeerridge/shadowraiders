<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>六芒星クリック</title>
<style>
  :root { --gap:10px; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee}
  h1{margin:0;font-size:18px}
  .small{font-size:12px;opacity:.75}
  main{padding:14px;display:grid;gap:16px;max-width:1100px;margin:0 auto}

  /* 入室 */
  .join-box{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .join-box input{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:16px}
  .btn{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .btn.ghost{background:#f8f8f8;color:#111}
  .hidden{display:none !important}

  /* 2カラム：左＝長方形ドラッグ盤 / 右＝図形 */
  .board{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){ .board{grid-template-columns:1fr} }

  /* 左：ドラッグ用長方形 */
  .dropzone{
    position:relative;
    height:70vh;
    min-height:360px;
    border:2px dashed #88a;
    border-radius:12px;
    background:#f7fbff;
    overflow:hidden; /* はみ出し防止 */
    touch-action:none; /* タッチドラッグのため */
  }
  .chip{
    position:absolute;
    width:44px;height:44px;line-height:44px;
    border-radius:50%;
    background:#111;color:#fff;
    text-align:center;font-weight:700;font-size:20px;
    user-select:none;
    cursor:grab;
    box-shadow:0 2px 8px rgba(0,0,0,.12);
  }
  .chip:active{ cursor:grabbing; }

  /* 右：図形エリア */
  .star-wrap{
    display:grid;
    place-items:center;
    height:70vh;
    min-height:360px;
    border:1px solid #eee;
    border-radius:12px;
    padding:12px;
  }
  svg{max-width:min(92vw,700px); max-height:60vh;}
  .cell { cursor:pointer; transition:opacity .1s ease; }
  .cell:hover { opacity:.9; }

  /* 着色（視認性） */
  .penta { fill:#eaf4ff; stroke:#0d4660; stroke-width:1.5; }
  .hex   { fill:#0b2431;  stroke:#0d4660; stroke-width:1.5; fill-opacity:.08; }
  .outline{ fill:none; stroke:#0d4660; stroke-width:2; opacity:.9; }
  .label { font-weight:700; font-size:28px; pointer-events:none; fill:#0d4660; }
</style>
</head>
<body>
<header>
  <h1>六芒星クリック</h1>
  <div class="small" id="headerInfo"></div>
</header>

<main>
  <!-- 名前登録 -->
  <section id="joinPanel" class="join-box">
    <!-- 名前：1文字のみ（アルファベット/ひらがな/カタカナ/漢字）。未入力なら自動で英字1文字 -->
    <input id="nameInput" placeholder="名前（1文字）" maxlength="1" inputmode="text" />
    <button id="btnJoin" class="btn">開始</button>
  </section>

  <!-- 左右レイアウト -->
  <section class="board hidden" id="board">
    <!-- 左：ドラッグ長方形 -->
    <div class="dropzone" id="dropzone" aria-label="ドラッグ盤">
      <!-- 入室後に .chip を生成 -->
    </div>

    <!-- 右：図形 -->
    <div class="star-wrap">
      <svg id="starSvg" viewBox="-100 -100 200 200" aria-label="六芒星" role="img"></svg>
    </div>
  </section>
</main>

<script type="module">
  // --- DOM ---
  const headerInfo = document.getElementById('headerInfo');
  const joinPanel  = document.getElementById('joinPanel');
  const nameInput  = document.getElementById('nameInput');
  const btnJoin    = document.getElementById('btnJoin');
  const board      = document.getElementById('board');

  const dropzone   = document.getElementById('dropzone');
  const svg        = document.getElementById('starSvg');

  // --- 状態 ---
  const state = {
    name: "",
    labelEl: null,
    chipEl: null,
    dragging: false,
    dragOffsetX: 0,
    dragOffsetY: 0
  };

  // --- ユーティリティ ---
  function randomLetter(){
    return String.fromCharCode(65 + Math.floor(Math.random()*26)); // A-Z
  }
  // 許可：A-Za-z / ひらがな / カタカナ / CJK(漢字)
  const NAME_RE = /^[A-Za-z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]$/;
  function normalizeName(raw){
    const t = (raw || "").trim();
    if (!t) return randomLetter();
    const c = t[0];
    return NAME_RE.test(c) ? c : randomLetter();
  }
  function show(el, yes){ el.classList.toggle('hidden', !yes); }

  // --- 右：図形生成（中央六角＋周囲五角） ---
  function buildStar(R = 92, r = 52){
    const deg2rad = d => (Math.PI/180) * d;

    // 六角の外接半径R / 内側半径r（中央）
    const outer = Array.from({length:6}, (_,i)=>{
      const ang = deg2rad(60*i - 90);
      return [ R*Math.cos(ang), R*Math.sin(ang) ];
    });
    const inner = Array.from({length:6}, (_,i)=>{
      const ang = deg2rad(60*i - 90);
      return [ r*Math.cos(ang), r*Math.sin(ang) ];
    });

    // 中央六角形
    const hexPts = inner.map(([x,y])=>`${x},${y}`).join(' ');
    const hex = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    hex.setAttribute('points', hexPts);
    hex.setAttribute('class','cell hex');
    hex.dataset.cell = 'center';
    svg.appendChild(hex);

    // 各辺に家形の五角形を付与
    for(let i=0;i<6;i++){
      const i0 = i;
      const i1 = (i+1)%6;

      const baseA = inner[i0];         // 中央六角の辺の端1
      const baseB = inner[i1];         // 中央六角の辺の端2
      const outA  = outer[i0];         // 右肩
      const outB  = outer[i1];         // 左肩

      // 辺の外向き法線方向の中点へ「先端」を置く
      const mid   = [(baseA[0]+baseB[0])/2, (baseA[1]+baseB[1])/2];
      // 法線ベクトル（辺ベクトルを90度回転→外側へ）
      const vx = baseB[0]-baseA[0], vy = baseB[1]-baseA[1];
      const nx = -vy, ny = vx;
      const nlen = Math.hypot(nx,ny) || 1;
      const tipLen = (R - r) * 1.05; // 少しだけ外へ
      const tip = [ mid[0] + (nx/nlen)*tipLen, mid[1] + (ny/nlen)*tipLen ];

      // 五角形の頂点順：baseA -> baseB -> tip -> outB -> outA
      const penta = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      penta.setAttribute('points', `${baseA[0]},${baseA[1]} ${baseB[0]},${baseB[1]} ${tip[0]},${tip[1]} ${outB[0]},${outB[1]} ${outA[0]},${outA[1]}`);
      penta.setAttribute('class','cell penta');
      penta.dataset.cell = `penta-${i}`;
      svg.appendChild(penta);
    }

    // 外周（見栄え用）
    const outline = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    outline.setAttribute('points', outer.map(([x,y])=>`${x},${y}`).join(' '));
    outline.setAttribute('class','outline');
    svg.appendChild(outline);
  }

  // SVG座標への変換
  function toSvgPoint(svgEl, clientX, clientY){
    const pt = svgEl.createSVGPoint();
    pt.x = clientX; pt.y = clientY;
    const ctm = svgEl.getScreenCTM();
    return pt.matrixTransform(ctm.inverse());
  }

  // クリック時のラベル配置（常に1つだけ）
  function placeLabelAt(x, y, text){
    if (state.labelEl && state.labelEl.parentNode) {
      state.labelEl.parentNode.removeChild(state.labelEl);
    }
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x);
    t.setAttribute('y', y);
    t.setAttribute('text-anchor','middle');
    t.setAttribute('dominant-baseline','middle');
    t.setAttribute('class','label');
    t.textContent = text;
    svg.appendChild(t);
    state.labelEl = t;
  }

  // --- 左：ドラッグ処理（自由配置・領域内制限） ---
  function makeDraggableChip(letter){
    if (state.chipEl) state.chipEl.remove();
    const el = document.createElement('div');
    el.className = 'chip';
    el.textContent = letter || '?';
    dropzone.appendChild(el);
    // 初期位置：中央
    const dzRect = dropzone.getBoundingClientRect();
    const x = (dzRect.width  - 44)/2;
    const y = (dzRect.height - 44)/2;
    el.style.left = x + 'px';
    el.style.top  = y + 'px';

    const onPointerDown = (ev) => {
      ev.preventDefault();
      el.setPointerCapture?.(ev.pointerId);
      state.dragging = true;
      const r = el.getBoundingClientRect();
      state.dragOffsetX = ev.clientX - r.left;
      state.dragOffsetY = ev.clientY - r.top;
    };
    const onPointerMove = (ev) => {
      if (!state.dragging) return;
      const dz = dropzone.getBoundingClientRect();
      let nx = ev.clientX - dz.left - state.dragOffsetX;
      let ny = ev.clientY - dz.top  - state.dragOffsetY;
      // クリップ
      nx = Math.max(0, Math.min(nx, dz.width  - 44));
      ny = Math.max(0, Math.min(ny, dz.height - 44));
      el.style.left = nx + 'px';
      el.style.top  = ny + 'px';
    };
    const onPointerUp = (ev) => {
      state.dragging = false;
      el.releasePointerCapture?.(ev.pointerId);
    };

    el.addEventListener('pointerdown', onPointerDown);
    window.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup',   onPointerUp);
    window.addEventListener('pointercancel', onPointerUp);

    state.chipEl = el;
  }

  // --- イベント ---
  btnJoin.onclick = () => {
    state.name = normalizeName(nameInput.value);
    headerInfo.textContent = `あなた：${state.name}`;
    show(joinPanel, false);
    show(board, true);

    // 左：ドラッグチップ
    makeDraggableChip(state.name);

    // 右：図形
    if (!svg.hasChildNodes()) buildStar();
  };

  // 図形のセルだけ反応
  svg.addEventListener('click', (e)=>{
    const target = e.target;
    if (!(target instanceof SVGElement)) return;
    if (!target.classList.contains('cell')) return; // クリック対象のみ
    const p = toSvgPoint(svg, e.clientX, e.clientY);
    placeLabelAt(p.x, p.y, state.name || '？');
  });

  // URLパラメータで名前を事前入力（任意）
  try{
    const qs = new URLSearchParams(location.search);
    const qName = (qs.get('name')||'').trim();
    if (qName) nameInput.value = qName.slice(0,1);
  }catch(_e){}
</script>
</body>
</html>
