<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ãƒãƒ£ãƒƒãƒˆï¼ˆãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰å¼ï¼‰</title>
<style>
  :root{ --maxw:880px; }
  *{ box-sizing:border-box; }
  body{
    margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans",
    "Noto Sans JP", "Yu Gothic UI", "Yu Gothic", "Meiryo", sans-serif;
    background:#0b0f14; color:#e6edf3;
    display:flex; min-height:100vh; align-items:center; justify-content:center;
  }
  .card{
    width:min(100%, var(--maxw)); background:#0f1722; border:1px solid #1f2a37;
    border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  h1{ font-size:20px; margin:0 0 16px; letter-spacing:.02em; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .field{ flex:1 1 200px; }
  label{ display:block; font-size:13px; color:#9fb0c0; margin:0 0 6px; }
  input{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid #243145;
    background:#0b121d; color:#e6edf3; outline:none;
  }
  input:focus{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.2); }
  button{
    padding:12px 16px; border-radius:12px; border:1px solid #2a3a54; cursor:pointer;
    background:#1b2a41; color:#e6edf3; font-weight:600;
  }
  button.primary{ background:#2563eb; border-color:#2563eb; }
  button:hover{ filter:brightness(1.05); }
  .hint{ font-size:12px; color:#7f93a8; margin-top:4px; }

  .hidden{ display:none !important; }

  /* chat area */
  .header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px; border:1px solid #1f2a37; border-radius:12px; background:#0b121d;
    margin:8px 0 16px;
  }
  .pill{ padding:6px 10px; border:1px solid #2a3a54; border-radius:999px; font-size:12px; color:#b9c7d6; }
  .list{
    height:48vh; min-height:320px; overflow:auto; padding:12px; border:1px solid #1f2a37;
    border-radius:12px; background:#0b121d;
  }
  .msg{
    margin:0 0 10px; display:flex; gap:8px; align-items:flex-start;
  }
  .me .bubble{ background:#1f3b78; }
  .other .bubble{ background:#1d2636; }
  .bubble{
    max-width:75%; padding:10px 12px; border-radius:14px;
    white-space:pre-wrap; word-break:break-word; border:1px solid #2a3a54;
  }
  .meta{ font-size:11px; color:#8394a7; margin-top:4px; }
  .foot{
    display:flex; gap:8px; margin-top:10px;
  }
  .foot input{ flex:1; }
  .copy{ font-size:12px; }
</style>
</head>
<body>
  <div class="card" id="screen-join">
    <h1>ãƒãƒ£ãƒƒãƒˆã«å…¥å®¤</h1>
    <div class="row">
      <div class="field">
        <label for="name">åå‰ï¼ˆ1æ–‡å­—ï¼šè‹±å­—/æ¼¢å­—/ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠï¼‰</label>
        <input id="name" placeholder="ä¾‹ï¼‰A / å¤ª / ã‚ / ã‚¿" maxlength="4" autocomplete="off" />
        <div class="hint">æœªå…¥åŠ›ãªã‚‰ãƒ©ãƒ³ãƒ€ãƒ è‹±å­—1æ–‡å­—ãŒè‡ªå‹•è¨­å®šã•ã‚Œã¾ã™ã€‚</div>
      </div>
      <div class="field">
        <label for="code">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰</label>
        <input id="code" placeholder="ä¾‹ï¼‰0275ï¼ˆæœªå…¥åŠ›ãªã‚‰è‡ªå‹•ç”Ÿæˆï¼‰" inputmode="numeric" autocomplete="off" />
        <div class="hint">åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ãŸäººã¯åŒã˜éƒ¨å±‹ã«å…¥ã‚Šã¾ã™ã€‚</div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="primary" id="enter">å…¥å®¤</button>
    </div>
  </div>

  <div class="card hidden" id="screen-chat">
    <div class="header">
      <div>
        <div class="pill" id="room-pill">ROOM ----</div>
        <div class="hint" id="me-pill" style="margin-top:6px">ã‚ãªãŸï¼š-</div>
      </div>
      <div class="row" style="gap:6px">
        <button id="copy-code" class="copy">ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="leave">é€€å‡º</button>
      </div>
    </div>
    <div id="messages" class="list" aria-live="polite"></div>
    <div class="foot">
      <input id="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ Enter" />
      <button id="send" class="primary">é€ä¿¡</button>
    </div>
  </div>

  <!-- Firebase SDK (v10+ modular) -->
  <script type="module">
    // ================= Firebase åˆæœŸåŒ– =================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, collection, addDoc,
      serverTimestamp, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASUJcPyybcD9q77XDatI5bCzZxDvsBH_o",
      authDomain: "shadowraiders-a2dbc.firebaseapp.com",
      projectId: "shadowraiders-a2dbc",
      storageBucket: "shadowraiders-a2dbc.firebasestorage.app",
      messagingSenderId: "577276689873",
      appId: "1:577276689873:web:9a13faf90c3d6a791e34f0",
      measurementId: "G-PKNEPDBVSS"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ================= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =================
    const $ = (sel) => document.querySelector(sel);
    const screenJoin = $("#screen-join");
    const screenChat = $("#screen-chat");
    const nameInput  = $("#name");
    const codeInput  = $("#code");
    const enterBtn   = $("#enter");
    const messagesEl = $("#messages");
    const textInput  = $("#text");
    const sendBtn    = $("#send");
    const roomPill   = $("#room-pill");
    const mePill     = $("#me-pill");

    // ç«¯æœ«ã”ã¨ã®ç°¡æ˜“IDï¼ˆåŒ¿åAuthä¸è¦ï¼‰
    const clientId = (() => {
      const k = "chat-client-id";
      let v = localStorage.getItem(k);
      if(!v){ v = crypto.randomUUID(); localStorage.setItem(k, v); }
      return v;
    })();

    // åå‰ï¼š1æ–‡å­—ã®ã¿è¨±å®¹ï¼ˆè‹±å­—/ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠ/æ¼¢å­—ï¼‰ã€‚æœªå…¥åŠ›ãªã‚‰è‹±å¤§æ–‡å­—1æ–‡å­—ã‚’ä»˜ä¸
    function normalizeName(input){
      const s = (input || "").trim();
      let ch = null;
      for(const c of Array.from(s)){ // ã‚µãƒ­ã‚²ãƒ¼ãƒˆå¯¾å¿œã§1ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆãšã¤
        if (/^[A-Za-z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]$/.test(c)) { ch = c; break; }
      }
      if(!ch){
        ch = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // 'A'ã€œ'Z'
      }
      return ch;
    }

    // ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ï¼šæ•°å­—ã®ã¿4æ¡ã€‚æœªå…¥åŠ›ãªã‚‰ãƒ©ãƒ³ãƒ€ãƒ 4æ¡ã‚’ç”Ÿæˆ
    function normalizeCode(input){
      const digits = String(input || "").replace(/\D/g, "");
      if(digits.length === 4) return digits;
      const rnd = Math.floor(Math.random() * 10000);
      return String(rnd).padStart(4, "0");
    }

    function scrollToBottom(){
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // ================= å…¥å®¤å‡¦ç† =================
    let roomRef = null;
    let unsubMessages = null;
    let myName = "-";
    let roomCode = "----";

    async function enterRoom(){
      myName   = normalizeName(nameInput.value);
      roomCode = normalizeCode(codeInput.value);

      // UIåæ˜ ï¼†ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
      nameInput.value = myName;
      codeInput.value = roomCode;
      localStorage.setItem("lastName", myName);
      localStorage.setItem("lastCode", roomCode);

      // ãƒ«ãƒ¼ãƒ ä½œæˆï¼ˆãªã‘ã‚Œã°ï¼‰ï¼å­˜åœ¨ã—ã¦ã„ã‚Œã°å‚åŠ 
      roomRef = doc(db, "rooms", roomCode);
      const exists = (await getDoc(roomRef)).exists();
      await setDoc(roomRef, { createdAt: serverTimestamp() }, { merge: true });

      // ãƒ¡ãƒ³ãƒãƒ¼ç™»éŒ²ï¼ˆç°¡æ˜“ï¼‰
      await setDoc(doc(db, "rooms", roomCode, "members", clientId), {
        name: myName,
        joinedAt: serverTimestamp()
      }, { merge: true });

      // æ—¢ã«éƒ¨å±‹ãŒã‚ã£ãŸã®ã‹ã€æ–°è¦ãªã®ã‹ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è»½ãæ®‹ã™ï¼ˆä»»æ„ï¼‰
      await addDoc(collection(db, "rooms", roomCode, "messages"), {
        text: exists ? `ğŸ”” ${myName} ã•ã‚“ãŒå…¥å®¤ã—ã¾ã—ãŸ` : `ğŸšª ãƒ«ãƒ¼ãƒ  ${roomCode} ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼ˆä½œæˆè€…ï¼š${myName}ï¼‰`,
        name: "SYSTEM",
        createdAt: serverTimestamp()
      });

      // ç”»é¢åˆ‡æ›¿
      screenJoin.classList.add("hidden");
      screenChat.classList.remove("hidden");
      roomPill.textContent = `ROOM ${roomCode}`;
      mePill.textContent   = `ã‚ãªãŸï¼š${myName}`;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è³¼èª­
      if (unsubMessages) unsubMessages();
      const q = query(collection(db, "rooms", roomCode, "messages"), orderBy("createdAt", "asc"));
      unsubMessages = onSnapshot(q, snap => {
        messagesEl.innerHTML = "";
        snap.forEach(docSnap => {
          const m = docSnap.data();
          const isMe = m.name === myName;
          const item = document.createElement("div");
          item.className = `msg ${isMe ? "me" : "other"}`;
          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.textContent = m.text || "";
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = (m.name || "åŒ¿å");
          const wrap = document.createElement("div");
          wrap.appendChild(bubble);
          wrap.appendChild(meta);
          item.appendChild(wrap);
          messagesEl.appendChild(item);
        });
        scrollToBottom();
      });

      textInput.focus();
    }

    async function sendMessage(){
      const text = textInput.value.trim();
      if(!text) return;
      await addDoc(collection(db, "rooms", roomCode, "messages"), {
        text, name: myName, createdAt: serverTimestamp()
      });
      textInput.value = "";
      textInput.focus();
    }

    // ================= ã‚¤ãƒ™ãƒ³ãƒˆçµç·š =================
    // å‰å›ã®å…¥åŠ›ã‚’å¾©å…ƒ
    const lastName = localStorage.getItem("lastName");
    const lastCode = localStorage.getItem("lastCode");
    if(lastName) nameInput.value = lastName;
    if(lastCode) codeInput.value = lastCode;

    enterBtn.addEventListener("click", enterRoom);
    codeInput.addEventListener("keydown", e => { if(e.key === "Enter") enterRoom(); });
    nameInput.addEventListener("keydown", e => { if(e.key === "Enter") enterRoom(); });

    sendBtn.addEventListener("click", sendMessage);
    textInput.addEventListener("keydown", e => { if(e.key === "Enter") sendMessage(); });

    $("#leave").addEventListener("click", () => {
      // è»½ã„é€€å®¤ãƒ­ã‚°ï¼ˆä»»æ„ï¼‰
      if (roomRef && roomCode && myName) {
        addDoc(collection(db, "rooms", roomCode, "messages"), {
          text:`ğŸ‘‹ ${myName} ã•ã‚“ãŒé€€å‡ºã—ã¾ã—ãŸ`, name:"SYSTEM", createdAt: serverTimestamp()
        });
      }
      // ç”»é¢æˆ»ã™
      screenChat.classList.add("hidden");
      screenJoin.classList.remove("hidden");
      textInput.value = "";
      messagesEl.innerHTML = "";
      roomRef = null;
    });

    $("#copy-code").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(roomCode);
        alert(`ã‚³ãƒ¼ãƒ‰ ${roomCode} ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
      }catch(_){ /* noop */ }
    });

    // ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹æ™‚ã«è»½ãè¨˜éŒ²ï¼ˆä»»æ„ï¼‰
    window.addEventListener("beforeunload", () => {
      if(roomCode){
        addDoc(collection(db, "rooms", roomCode, "messages"), {
          text:`ğŸšª ${myName} ã•ã‚“ãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ`, name:"SYSTEM", createdAt: serverTimestamp()
        });
      }
    });
  </script>

  <!--
    â– ãƒ¡ãƒ¢
    - Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã¯æœ¬ç•ªã«åˆã‚ã›ã¦å¿…ãšè¨­å®šã—ã¦ãã ã•ã„ã€‚
    - ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã¯åŒ¿åèªè¨¼ã‚’ä½¿ã‚ãšã€ç«¯æœ«ã”ã¨ã®ç°¡æ˜“IDã§ãƒ¡ãƒ³ãƒãƒ¼è¨˜éŒ²ã‚’ã—ã¦ã„ã¾ã™ã€‚
    - åå‰ã¯ 1 æ–‡å­—ã®ã¿ï¼ˆè‹±å­—/æ¼¢å­—/ã²ã‚‰ãŒãª/ã‚«ã‚¿ã‚«ãƒŠï¼‰ã€‚æœªå…¥åŠ›æ™‚ã¯è‹±å¤§æ–‡å­— 1 æ–‡å­—ã‚’è‡ªå‹•ä»˜ä¸ã€‚
    - ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã¯ 4 æ¡ã€‚æœªå…¥åŠ›æ™‚ã¯ 0000ã€œ9999 ã§è‡ªå‹•ç”Ÿæˆã€‚
    - åŒã˜ã‚³ãƒ¼ãƒ‰ã®äººã¯åŒã˜ rooms/{code} ã«æ¥ç¶šã—ã€messages ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…±æœ‰ã—ã¾ã™ã€‚
  -->
</body>
</html>
