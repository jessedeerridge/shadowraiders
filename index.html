<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>シンプルオンラインルーム（六芒星）</title>
<style>
  :root { --gap:10px; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee}
  h1{margin:0;font-size:18px}
  .small{font-size:12px;opacity:.85}
  main{padding:14px;display:grid;gap:16px;max-width:900px;margin:0 auto}
  .join-box{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .join-box input{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:16px}
  .btn{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .btn.ghost{background:#f8f8f8;color:#111}
  .code-link{ text-decoration: underline; cursor: pointer; }

  /* ルーム画面 */
  .wrap{display:grid;grid-template-rows:1fr auto;gap:var(--gap)}
  .stage{
    position:relative;
    aspect-ratio:1/1;
    width:min(92vw, 560px);
    margin:0 auto;
  }
  svg{width:100%;height:100%;display:block}

  /* 名前ラベル */
  .labels{ position:absolute; inset:0; pointer-events:none; }
  .label{
    position:absolute; transform:translate(-50%,-80%);
    background:rgba(255,255,255,.9); border:1px solid #ddd; border-radius:10px;
    padding:2px 6px; font-weight:700; font-size:14px; white-space:nowrap;
    box-shadow:0 1px 3px rgba(0,0,0,.08);
  }

  /* 見た目：画像のように線画で表示。クリック領域は透明でホバー時だけ薄く色付け */
  .outline polygon{ fill:none; stroke:#111; stroke-width:3; stroke-linejoin:round; }
  .area{ fill:rgba(0,0,0,0.0001); cursor:pointer; }          /* 透明だがクリック可 */
  .area:hover{ fill:rgba(100,150,255,0.12); }                /* ホバーでうっすら */
</style>
</head>
<body>
<header>
  <h1>シンプルオンラインルーム</h1>
  <div class="small" id="headerInfo"></div>
</header>

<main>
  <!-- 入室画面 -->
  <section id="joinPanel" class="join-box">
    <input id="nameInput" placeholder="名前（1文字）" maxlength="1" inputmode="text" />
    <input id="codeInput" placeholder="ルームコード（例: 1234）" maxlength="12" inputmode="numeric" />
    <button id="btnJoin" class="btn">入室</button>
  </section>

  <!-- ルーム画面（六芒星） -->
  <section id="roomPanel" class="wrap" style="display:none;">
    <div class="stage" id="stage">
      <!-- 正六芒星：二つの正三角形（輪郭）＋ 内側6三角形と中央六角形（クリック領域） -->
      <svg id="starSvg" viewBox="0 0 100 100" aria-label="六芒星（クリックで名前を置く）">
        <!-- 輪郭（画像と同じ見た目） -->
        <g class="outline" pointer-events="none">
          <!-- 上向き正三角形 -->
          <polygon points="50,6 88.11,72 11.89,72" />
          <!-- 下向き正三角形 -->
          <polygon points="50,94 88.11,28 11.89,28" />
        </g>

        <!-- クリック領域（内側6三角形 + 中央六角形） -->
        <!-- 中央六角形の頂点（正確な交点）：
             37.30,28.00 / 62.70,28.00 / 75.41,50.00 / 62.70,72.00 / 37.30,72.00 / 24.59,50.00 -->
        <!-- 三角は各頂点＋隣接する内側六角形の2点で構成 -->
        <polygon class="area" data-pos="0" points="88.11,28.00 62.70,28.00 75.41,50.00" /> <!-- 右上 -->
        <polygon class="area" data-pos="1" points="88.11,72.00 75.41,50.00 62.70,72.00" /> <!-- 右下 -->
        <polygon class="area" data-pos="2" points="50.00,94.00 62.70,72.00 37.30,72.00" /> <!-- 下 -->
        <polygon class="area" data-pos="3" points="11.89,72.00 37.30,72.00 24.59,50.00" /> <!-- 左下 -->
        <polygon class="area" data-pos="4" points="11.89,28.00 24.59,50.00 37.30,28.00" /> <!-- 左上 -->
        <polygon class="area" data-pos="5" points="50.00,6.00 37.30,28.00 62.70,28.00" />  <!-- 上 -->
        <!-- 中央六角形 -->
        <polygon class="area" data-pos="6"
                 points="37.30,28.00 62.70,28.00 75.41,50.00 62.70,72.00 37.30,72.00 24.59,50.00" />
      </svg>
      <div class="labels" id="labels"></div>
    </div>

    <div style="text-align:center">
      <button id="btnLeave" class="btn ghost">退室</button>
    </div>
  </section>
</main>

<!-- Firebase（v9 モジュール） -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  /* あなたの Firebase 設定 */
  const firebaseConfig = {
    apiKey: "AIzaSyASUJcPyybcD9q77XDatI5bCzZxDvsBH_o",
    authDomain: "shadowraiders-a2dbc.firebaseapp.com",
    projectId: "shadowraiders-a2dbc",
    storageBucket: "shadowraiders-a2dbc.firebasestorage.app",
    messagingSenderId: "577276689873",
    appId: "1:577276689873:web:9a13faf90c3d6a791e34f0",
    measurementId: "G-PKNEPDBVSS"
  };

  // --- 初期化 ---
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // --- DOM ---
  const headerInfo = document.getElementById('headerInfo');
  const joinPanel  = document.getElementById('joinPanel');
  const nameInput  = document.getElementById('nameInput');
  const codeInput  = document.getElementById('codeInput');
  const btnJoin    = document.getElementById('btnJoin');

  const roomPanel  = document.getElementById('roomPanel');
  const stageEl    = document.getElementById('stage');
  const labelsEl   = document.getElementById('labels');
  const btnLeave   = document.getElementById('btnLeave');

  // --- 状態 ---
  const state = { uid: crypto.randomUUID(), name:"", code:"", joined:false, off:[] };

  // --- ユーティリティ ---
  function randomLetter(){ return String.fromCharCode(65 + Math.floor(Math.random()*26)); }
  function random4(){ return String(Math.floor(Math.random()*10000)).padStart(4, '0'); }
  const NAME_RE = /^[A-Za-z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]$/;
  function normalizeName(raw){
    const t = (raw || "").trim(); if (!t) return randomLetter();
    const c = t[0]; return NAME_RE.test(c) ? c : randomLetter();
  }
  function buildRoomLink(code){ const url = new URL(location.href); url.searchParams.set('room', code); return url.toString(); }
  function showJoin(yes){ joinPanel.style.display = yes ? '' : 'none'; roomPanel.style.display = yes ? 'none' : ''; }

  // ラベル再描画
  function renderLabels(map){
    labelsEl.innerHTML = '';
    if (!map) return;
    for (const [uid, v] of Object.entries(map)){
      if (!v || typeof v.x !== 'number' || typeof v.y !== 'number') continue;
      const d = document.createElement('div');
      d.className = 'label';
      d.textContent = v.name || '?';
      d.style.left = `${v.x}%`;
      d.style.top  = `${v.y}%`;
      labelsEl.appendChild(d);
    }
  }

  // --- 入室 ---
  async function join(){
    const name = normalizeName(nameInput.value);
    const code = (codeInput.value || "").trim() || random4();
    state.name = name; state.code = code;

    const meRef = ref(db, `rooms/${code}/participants/${state.uid}`);
    await set(meRef, { name, at: Date.now() });
    onDisconnect(meRef).remove();

    const myPlaceRef = ref(db, `rooms/${code}/placements/${state.uid}`);
    onDisconnect(myPlaceRef).remove();

    // 右上（ヘッダー右）にコードと名前のみ
    const link = buildRoomLink(code);
    headerInfo.innerHTML = `コード：<span class="code-link" id="headerCode">${code}</span>　/　あなた：<strong>${name}</strong>`;
    setTimeout(()=>{
      const codeEl = document.getElementById('headerCode');
      if (codeEl){
        codeEl.onclick = ()=>{
          if (navigator.clipboard) {
            navigator.clipboard.writeText(link).then(()=> alert('招待リンクをコピーしました'));
          } else {
            prompt('コピーできない場合はこのテキストをコピーしてください', link);
          }
        };
      }
    },0);

    showJoin(false); state.joined = true;

    // 配置の監視（全員分）
    const placesRef = ref(db, `rooms/${code}/placements`);
    const offPlaces = onValue(placesRef, (snap)=>{ renderLabels(snap.val() || {}); });
    state.off.push(offPlaces);
  }

  // --- 退室 ---
  async function leave(){
    if (!state.joined) return;
    const { code } = state;
    await remove(ref(db, `rooms/${code}/participants/${state.uid}`));
    await remove(ref(db, `rooms/${code}/placements/${state.uid}`));
    state.off.forEach(fn => fn && fn()); state.off = [];
    renderLabels(null); headerInfo.textContent = '';
    showJoin(true); state.joined = false;
  }

  // --- クリック → 自分の名前を置く（常に最新1つ） ---
  function onStarClick(ev){
    if (!state.joined) return;
    const target = ev.target;
    if (!(target instanceof SVGElement)) return;
    const posIdx = target.dataset?.pos;
    if (posIdx === undefined) return; // 輪郭は対象外

    const rect = stageEl.getBoundingClientRect();
    const xPct = ((ev.clientX - rect.left) / rect.width) * 100;
    const yPct = ((ev.clientY - rect.top)  / rect.height) * 100;

    const payload = {
      name: state.name,
      pos: Number(posIdx),   // 0..5=内側三角, 6=中央六角
      x: Math.max(0, Math.min(100, +xPct.toFixed(1))),
      y: Math.max(0, Math.min(100, +yPct.toFixed(1))),
      at: Date.now()
    };
    set(ref(db, `rooms/${state.code}/placements/${state.uid}`), payload);
  }

  // --- イベント ---
  document.getElementById('btnJoin').onclick = join;
  document.getElementById('btnLeave').onclick = leave;
  document.getElementById('starSvg').addEventListener('click', onStarClick);
  window.addEventListener('beforeunload', leave);
  nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') join(); });
  codeInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') join(); });

  // URL パラメータで事前入力（任意）
  try{
    const qs = new URLSearchParams(location.search);
    const qRoom = (qs.get('room')||'').trim();
    const qName = (qs.get('name')||'').trim();
    if (qRoom) codeInput.value = qRoom.slice(0, 12);
    if (qName) nameInput.value = qName.slice(0, 1);
  }catch(_e){}
</script>
</body>
</html>
