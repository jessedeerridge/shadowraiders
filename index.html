<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>六芒星クリック</title>
<style>
  :root { --gap:10px; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee}
  h1{margin:0;font-size:18px}
  .small{font-size:12px;opacity:.75}
  main{padding:14px;display:grid;gap:16px;max-width:1100px;margin:0 auto}

  /* 入室 */
  .join-box{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .join-box input{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:16px}
  .btn{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .btn.ghost{background:#f8f8f8;color:#111}
  .hidden{display:none !important}

  /* 2カラム：左＝長方形ドラッグ盤 / 右＝図形 */
  .board{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:900px){ .board{grid-template-columns:1fr} }

  /* 左：ドラッグ用長方形 */
  .dropzone{
    position:relative;
    height:70vh;
    min-height:360px;
    border:2px dashed #88a;
    border-radius:12px;
    background:#f7fbff;
    overflow:hidden;         /* はみ出し防止 */
    touch-action:none;       /* タッチドラッグのため */
  }
  /* アイコンは「▢の中に名前1文字」 */
  .chip{
    position:absolute;
    width:44px;height:44px;line-height:44px;
    border-radius:8px;                 /* ← 四角（角丸） */
    background:#fff;                   /* 白地 */
    color:#111;
    text-align:center;font-weight:700;font-size:20px;
    user-select:none;
    cursor:grab;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    border:2px solid #111;             /* ← 枠線で“▢”表現 */
  }
  .chip:active{ cursor:grabbing; }

  /* 右：図形エリア */
  .star-wrap{
    display:grid;
    place-items:center;
    height:70vh;
    min-height:360px;
    border:1px solid #eee;
    border-radius:12px;
    padding:12px;
  }
  svg{max-width:min(92vw,700px); max-height:60vh;}
  .cell { cursor:pointer; transition:opacity .1s ease; }
  .cell:hover { opacity:.92; }

  /* 着色（視認性） */
  .diamond { fill:#eaf4ff; stroke:#0d4660; stroke-width:1.6; }
  .ring-outline{ fill:none; stroke:#0d4660; stroke-width:2; opacity:.9; }
  .label { font-weight:700; font-size:28px; pointer-events:none; fill:#0d4660; }
</style>
</head>
<body>
<header>
  <h1>六芒星クリック</h1>
  <div class="small" id="headerInfo"></div>
</header>

<main>
  <!-- 名前登録 -->
  <section id="joinPanel" class="join-box">
    <!-- 名前：1文字のみ（アルファベット/ひらがな/カタカナ/漢字）。未入力なら自動で英字1文字 -->
    <input id="nameInput" placeholder="名前（1文字）" maxlength="1" inputmode="text" />
    <button id="btnJoin" class="btn">開始</button>
  </section>

  <!-- 左右レイアウト -->
  <section class="board hidden" id="board">
    <!-- 左：ドラッグ長方形 -->
    <div class="dropzone" id="dropzone" aria-label="ドラッグ盤">
      <!-- 入室後に .chip を生成 -->
    </div>

    <!-- 右：図形 -->
    <div class="star-wrap">
      <svg id="starSvg" viewBox="-120 -120 240 240" aria-label="ひし形リング" role="img"></svg>
    </div>
  </section>
</main>

<script type="module">
  // --- DOM ---
  const headerInfo = document.getElementById('headerInfo');
  const joinPanel  = document.getElementById('joinPanel');
  const nameInput  = document.getElementById('nameInput');
  const btnJoin    = document.getElementById('btnJoin');
  const board      = document.getElementById('board');

  const dropzone   = document.getElementById('dropzone');
  const svg        = document.getElementById('starSvg');

  // --- 状態 ---
  const state = {
    name: "",
    labelEl: null,
    chipEl: null,
    dragging: false,
    dragOffsetX: 0,
    dragOffsetY: 0
  };

  // --- ユーティリティ ---
  function randomLetter(){
    return String.fromCharCode(65 + Math.floor(Math.random()*26)); // A-Z
  }
  // 許可：A-Za-z / ひらがな / カタカナ / CJK(漢字)
  const NAME_RE = /^[A-Za-z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]$/;
  function normalizeName(raw){
    const t = (raw || "").trim();
    if (!t) return randomLetter();
    const c = t[0];
    return NAME_RE.test(c) ? c : randomLetter();
  }
  function show(el, yes){ el.classList.toggle('hidden', !yes); }

  // 角度→ラジアン
  const deg2rad = d => (Math.PI/180) * d;

  /**
   * 右：ひし形が六個 円形につながった形
   * 各ひし形 i は基準角 θi（-90°スタートで60°刻み）。
   * 頂点は [外, 側(+30°), 内, 側(-30°)] の4点。
   * 側(+30°) は次のひし形の 側(-30°) と同一点を共有 → 連結表現。
   */
  function buildDiamondRing(Rout = 96, Rm = 74, Rin = 44){
    // ひし形6個
    for (let i=0;i<6;i++){
      const theta = -90 + 60*i;      // 基準角（外向きの頂点）
      const a0 = theta;
      const a1 = theta + 30;
      const a2 = theta + 180;
      const a3 = theta - 30;

      const p0 = [ Rout*Math.cos(deg2rad(a0)), Rout*Math.sin(deg2rad(a0)) ]; // 外
      const p1 = [  Rm*Math.cos(deg2rad(a1)),  Rm*Math.sin(deg2rad(a1)) ];   // 側(+30°)
      const p2 = [ Rin*Math.cos(deg2rad(a2)), Rin*Math.sin(deg2rad(a2)) ];   // 内
      const p3 = [  Rm*Math.cos(deg2rad(a3)),  Rm*Math.sin(deg2rad(a3)) ];   // 側(-30°)

      const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      poly.setAttribute('points', `${p0[0]},${p0[1]} ${p1[0]},${p1[1]} ${p2[0]},${p2[1]} ${p3[0]},${p3[1]}`);
      poly.setAttribute('class','cell diamond');
      poly.dataset.cell = `diamond-${i}`;
      svg.appendChild(poly);
    }

    // 外周の見栄え（オプション）
    const ring = document.createElementNS('http://www.w3.org/2000/svg','circle');
    ring.setAttribute('cx','0'); ring.setAttribute('cy','0');
    ring.setAttribute('r', String(Rout));
    ring.setAttribute('class','ring-outline');
    ring.setAttribute('opacity','0.25');
    svg.appendChild(ring);
  }

  // SVG座標への変換
  function toSvgPoint(svgEl, clientX, clientY){
    const pt = svgEl.createSVGPoint();
    pt.x = clientX; pt.y = clientY;
    const ctm = svgEl.getScreenCTM();
    return pt.matrixTransform(ctm.inverse());
  }

  // クリック時のラベル配置（常に1つだけ）
  function placeLabelAt(x, y, text){
    if (state.labelEl && state.labelEl.parentNode) {
      state.labelEl.parentNode.removeChild(state.labelEl);
    }
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x);
    t.setAttribute('y', y);
    t.setAttribute('text-anchor','middle');
    t.setAttribute('dominant-baseline','middle');
    t.setAttribute('class','label');
    t.textContent = text;
    svg.appendChild(t);
    state.labelEl = t;
  }

  // --- 左：ドラッグ処理（自由配置・領域内制限） ---
  function makeDraggableChip(letter){
    if (state.chipEl) state.chipEl.remove();
    const el = document.createElement('div');
    el.className = 'chip';
    el.textContent = letter || '?';
    dropzone.appendChild(el);
    // 初期位置：中央
    const dzRect = dropzone.getBoundingClientRect();
    const x = (dzRect.width  - 44)/2;
    const y = (dzRect.height - 44)/2;
    el.style.left = x + 'px';
    el.style.top  = y + 'px';

    const onPointerDown = (ev) => {
      ev.preventDefault();
      el.setPointerCapture?.(ev.pointerId);
      state.dragging = true;
      const r = el.getBoundingClientRect();
      state.dragOffsetX = ev.clientX - r.left;
      state.dragOffsetY = ev.clientY - r.top;
    };
    const onPointerMove = (ev) => {
      if (!state.dragging) return;
      const dz = dropzone.getBoundingClientRect();
      let nx = ev.clientX - dz.left - state.dragOffsetX;
      let ny = ev.clientY - dz.top  - state.dragOffsetY;
      // 盤内にクリップ
      nx = Math.max(0, Math.min(nx, dz.width  - 44));
      ny = Math.max(0, Math.min(ny, dz.height - 44));
      el.style.left = nx + 'px';
      el.style.top  = ny + 'px';
    };
    const onPointerUp = (ev) => {
      state.dragging = false;
      el.releasePointerCapture?.(ev.pointerId);
    };

    el.addEventListener('pointerdown', onPointerDown);
    window.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup',   onPointerUp);
    window.addEventListener('pointercancel', onPointerUp);

    state.chipEl = el;
  }

  // --- イベント ---
  btnJoin.onclick = () => {
    state.name = normalizeName(nameInput.value);
    headerInfo.textContent = `あなた：${state.name}`;
    show(joinPanel, false);
    show(board, true);

    // 左：ドラッグチップ
    makeDraggableChip(state.name);

    // 右：ひし形リング
    if (!svg.hasChildNodes()) buildDiamondRing();
  };

  // 図形のセルだけ反応
  svg.addEventListener('click', (e)=>{
    const target = e.target;
    if (!(target instanceof SVGElement)) return;
    if (!target.classList.contains('cell')) return; // クリック対象のみ
    const p = toSvgPoint(svg, e.clientX, e.clientY);
    placeLabelAt(p.x, p.y, state.name || '？');
  });

  // URLパラメータで名前を事前入力（任意）
  try{
    const qs = new URLSearchParams(location.search);
    const qName = (qs.get('name')||'').trim();
    if (qName) nameInput.value = qName.slice(0,1);
  }catch(_e){}
</script>
</body>
</html>
