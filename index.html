<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>六芒風（六角＋周囲五角形）クリック＆ドラッグ</title>
<style>
  :root { --gap:10px; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee}
  h1{margin:0;font-size:18px}
  .small{font-size:12px;opacity:.75}
  main{padding:14px;display:grid;gap:16px;max-width:900px;margin:0 auto}

  /* 入室 */
  .join-box{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .join-box input{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:16px}
  .btn{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .hidden{display:none !important}

  /* ボード（長方形） */
  .board-wrap{
    display:grid;place-items:center;
    height:70vh;border:1px solid #eee;border-radius:12px;padding:12px;
  }
  svg{max-width:min(92vw,700px); max-height:60vh; background:#fafafa; border-radius:10px;}
  .cell { cursor:pointer; transition:opacity .1s ease; }
  .cell:hover { opacity:.9; }
  /* 配色（視認性重視、自由に変更可） */
  .hex { fill:#fff7e6; stroke:#ffc266; stroke-width:1.2; }
  .penta { fill:#eef5ff; stroke:#9db8ff; stroke-width:1.2; }
  .outline { fill:none; stroke:#aaa; stroke-width:1.2; pointer-events:none; }
  .label { font-weight:700; font-size:28px; user-select:none; cursor:move; }
</style>
</head>
<body>
<header>
  <h1>六角＋周囲五角形：クリックで配置／ドラッグで移動</h1>
  <div class="small" id="headerInfo"></div>
</header>

<main>
  <!-- 名前登録 -->
  <section id="joinPanel" class="join-box">
    <input id="nameInput" placeholder="名前（1文字）" maxlength="1" inputmode="text" />
    <button id="btnJoin" class="btn">開始</button>
  </section>

  <!-- ボード（SVGは長方形領域内） -->
  <section id="boardPanel" class="hidden">
    <div class="board-wrap">
      <!-- viewBox は長方形（-120..120）で固定：ドラッグ制限にも使う -->
      <svg id="board" viewBox="-120 -120 240 240" aria-label="ボード" role="img"></svg>
    </div>
  </section>
</main>

<script type="module">
  // --- DOM ---
  const headerInfo = document.getElementById('headerInfo');
  const joinPanel  = document.getElementById('joinPanel');
  const nameInput  = document.getElementById('nameInput');
  const btnJoin    = document.getElementById('btnJoin');
  const boardPanel = document.getElementById('boardPanel');
  const svg        = document.getElementById('board');

  // --- 状態 ---
  const state = {
    name: "",
    dragging: null,   // ドラッグ中のtext要素
    dragOffset: {x:0,y:0}
  };

  // --- ユーティリティ ---
  function randomLetter(){
    return String.fromCharCode(65 + Math.floor(Math.random()*26)); // A-Z
  }
  const NAME_RE = /^[A-Za-z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]$/;
  function normalizeName(raw){
    const t = (raw || "").trim();
    if (!t) return randomLetter();
    const c = t[0];
    return NAME_RE.test(c) ? c : randomLetter();
  }
  function show(el, yes){ el.classList.toggle('hidden', !yes); }

  // SVG座標へ
  function toSvgPoint(svgEl, clientX, clientY){
    const pt = svgEl.createSVGPoint();
    pt.x = clientX; pt.y = clientY;
    const ctm = svgEl.getScreenCTM();
    return pt.matrixTransform(ctm.inverse());
  }

  // ボード境界（viewBox）に収める
  function clampToViewBox(x, y, margin=6){
    // viewBox: -120..+120 の長方形
    const min = -120 + margin;
    const max =  120 - margin;
    return { x: Math.min(max, Math.max(min, x)), y: Math.min(max, Math.max(min, y)) };
  }

  // ラベル生成（複数可）
  function createLabel(x, y, text){
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    const p = clampToViewBox(x,y,6);
    t.setAttribute('x', p.x);
    t.setAttribute('y', p.y);
    t.setAttribute('text-anchor','middle');
    t.setAttribute('dominant-baseline','middle');
    t.setAttribute('class','label');
    t.textContent = text;
    // ドラッグ開始
    t.addEventListener('pointerdown', (e)=>{
      const sp = toSvgPoint(svg, e.clientX, e.clientY);
      const cx = parseFloat(t.getAttribute('x'));
      const cy = parseFloat(t.getAttribute('y'));
      state.dragging = t;
      state.dragOffset.x = cx - sp.x;
      state.dragOffset.y = cy - sp.y;
      t.setPointerCapture(e.pointerId);
    });
    svg.appendChild(t);
  }

  // --- 図形生成：中央の正六角形＋周囲に“くっつく”五角形6つ ---
  function buildHexWithPentagons(R=84, r=48, spike=100){
    const d2r = d => (Math.PI/180)*d;

    // 中央正六角形（半径 r）
    const inner = Array.from({length:6}, (_,i)=>{
      const a = d2r(60*i - 90);
      return [ r*Math.cos(a), r*Math.sin(a) ];
    });
    const hex = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    hex.setAttribute('points', inner.map(([x,y])=>`${x},${y}`).join(' '));
    hex.setAttribute('class','cell hex');
    hex.dataset.cell = 'center';
    svg.appendChild(hex);

    // 周囲五角形：各辺の法線方向に“とんがり”を作り、内側六角形にくっつく形
    // 五角形の5点： inner[i], inner[i+1], shoulder1, tip(スパイク), shoulder2
    for(let i=0;i<6;i++){
      const a0 = d2r(60*i - 90);
      const a1 = d2r(60*(i+1) - 90);
      const mid = d2r(60*i + 30 - 90);   // 辺の外向き法線方向（スパイク方向）

      const v0 = [ r*Math.cos(a0), r*Math.sin(a0) ];
      const v1 = [ r*Math.cos(a1), r*Math.sin(a1) ];

      // 肩（外周の“縁”になる位置）：外側半径 R を使い、法線方向に少し振る
      const shoulderSpread = 18; // 肩の角度オフセット（見た目調整）
      const s1a = mid - d2r(shoulderSpread);
      const s2a = mid + d2r(shoulderSpread);
      const s1 = [ R*Math.cos(s1a), R*Math.sin(s1a) ];
      const s2 = [ R*Math.cos(s2a), R*Math.sin(s2a) ];

      // スパイクの先端
      const tip = [ spike*Math.cos(mid), spike*Math.sin(mid) ];

      const pent = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      pent.setAttribute('points', `${v0[0]},${v0[1]} ${v1[0]},${v1[1]} ${s1[0]},${s1[1]} ${tip[0]},${tip[1]} ${s2[0]},${s2[1]}`);
      pent.setAttribute('class','cell penta');
      pent.dataset.cell = `penta-${i}`;
      svg.appendChild(pent);
    }

    // 輪郭（外観補助）
    const outerHex = Array.from({length:6},(_,i)=>{
      const a = d2r(60*i - 90);
      return [ R*Math.cos(a), R*Math.sin(a) ];
    });
    const outline = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    outline.setAttribute('points', outerHex.map(([x,y])=>`${x},${y}`).join(' '));
    outline.setAttribute('class','outline');
    svg.appendChild(outline);
  }

  // --- イベント ---
  btnJoin.onclick = () => {
    state.name = normalizeName(nameInput.value);
    headerInfo.textContent = `あなた：${state.name}`;
    show(joinPanel, false);
    show(boardPanel, true);
    if (!svg.hasChildNodes()) buildHexWithPentagons();
  };

  // クリックでラベルを“追加”（複数可）
  svg.addEventListener('click', (e)=>{
    const target = e.target;
    if (!(target instanceof SVGElement)) return;
    if (!target.classList.contains('cell')) return; // クリック対象のみ
    const p = toSvgPoint(svg, e.clientX, e.clientY);
    createLabel(p.x, p.y, state.name || '？');
  });

  // ドラッグ移動（長方形内に制限）
  svg.addEventListener('pointermove', (e)=>{
    if (!state.dragging) return;
    const sp = toSvgPoint(svg, e.clientX, e.clientY);
    const x = sp.x + state.dragOffset.x;
    const y = sp.y + state.dragOffset.y;
    const p = clampToViewBox(x,y,6);
    state.dragging.setAttribute('x', p.x);
    state.dragging.setAttribute('y', p.y);
  });
  svg.addEventListener('pointerup', ()=>{ state.dragging = null; });
  svg.addEventListener('pointercancel', ()=>{ state.dragging = null; });

  // URLパラメータで名前を事前入力（任意）
  try{
    const qs = new URLSearchParams(location.search);
    const qName = (qs.get('name')||'').trim();
    if (qName) nameInput.value = qName.slice(0,1);
  }catch(_e){}
</script>
</body>
</html>
