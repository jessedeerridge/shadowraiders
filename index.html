<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>六芒星クリック</title>
<style>
  :root { --gap:10px; }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee}
  h1{margin:0;font-size:18px}
  .small{font-size:12px;opacity:.75}
  main{padding:14px;display:grid;gap:16px;max-width:900px;margin:0 auto}

  /* 入室 */
  .join-box{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .join-box input{padding:10px;border:1px solid #ddd;border-radius:8px;font-size:16px}
  .btn{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  .btn.ghost{background:#f8f8f8;color:#111}
  .hidden{display:none !important}

  /* 六芒星 */
  .star-wrap{
    display:grid;
    place-items:center;
    height:70vh;
    border:1px solid #eee;
    border-radius:12px;
    padding:12px;
  }
  svg{max-width:min(92vw,700px); max-height:60vh;}
  .cell { cursor:pointer; transition:opacity .1s ease; }
  .cell:hover { opacity:.85; }
  /* 着色（視認性のため） */
  .tri { fill:#f0f4ff; stroke:#99b3ff; }
  .hex { fill:#fff7e6; stroke:#ffc266; }
  .label { font-weight:700; font-size:28px; pointer-events:none; }
</style>
</head>
<body>
<header>
  <h1>六芒星クリック</h1>
  <div class="small" id="headerInfo"></div>
</header>

<main>
  <!-- 名前登録 -->
  <section id="joinPanel" class="join-box">
    <!-- 名前：1文字のみ（アルファベット/ひらがな/カタカナ/漢字）。未入力なら自動で英字1文字 -->
    <input id="nameInput" placeholder="名前（1文字）" maxlength="1" inputmode="text" />
    <button id="btnJoin" class="btn">開始</button>
  </section>

  <!-- 六芒星 -->
  <section id="starPanel" class="hidden">
    <div class="star-wrap">
      <svg id="starSvg" viewBox="-100 -100 200 200" aria-label="六芒星" role="img"></svg>
    </div>
  </section>
</main>

<script type="module">
  // --- DOM ---
  const headerInfo = document.getElementById('headerInfo');
  const joinPanel  = document.getElementById('joinPanel');
  const nameInput  = document.getElementById('nameInput');
  const btnJoin    = document.getElementById('btnJoin');
  const starPanel  = document.getElementById('starPanel');
  const svg        = document.getElementById('starSvg');

  // --- 状態 ---
  const state = {
    name: "",
    labelEl: null
  };

  // --- ユーティリティ ---
  function randomLetter(){
    return String.fromCharCode(65 + Math.floor(Math.random()*26)); // A-Z
  }
  // 許可：A-Za-z / ひらがな / カタカナ / CJK(漢字)
  const NAME_RE = /^[A-Za-z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]$/;
  function normalizeName(raw){
    const t = (raw || "").trim();
    if (!t) return randomLetter();
    const c = t[0];
    return NAME_RE.test(c) ? c : randomLetter();
  }
  function show(el, yes){ el.classList.toggle('hidden', !yes); }

  // --- 六芒星生成 ---
  // 正六角形の外接半径 R と内側六角形の半径 r を使い、6つの小三角形＋中央六角形を作る
  function buildStar(R = 90, r = 52){
    // 角度をラジアンで
    const deg2rad = d => (Math.PI/180) * d;
    // 正六角形の頂点（外・内）
    const outer = Array.from({length:6}, (_,i)=>{
      const ang = deg2rad(60*i - 90); // 上を起点(-90°)に回す
      return [ R*Math.cos(ang), R*Math.sin(ang) ];
    });
    const inner = Array.from({length:6}, (_,i)=>{
      const ang = deg2rad(60*i - 90);
      return [ r*Math.cos(ang), r*Math.sin(ang) ];
    });

    // 中央六角形
    const hexPts = inner.map(([x,y])=>`${x},${y}`).join(' ');
    const hex = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    hex.setAttribute('points', hexPts);
    hex.setAttribute('class','cell hex');
    hex.dataset.cell = 'center';
    svg.appendChild(hex);

    // 6つの小三角形（outer[i] と inner[i], inner[(i+1)%6]）
    for(let i=0;i<6;i++){
      const p0 = outer[i];
      const p1 = inner[i];
      const p2 = inner[(i+1)%6];
      const tri = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      tri.setAttribute('points', `${p0[0]},${p0[1]} ${p1[0]},${p1[1]} ${p2[0]},${p2[1]}`);
      tri.setAttribute('class','cell tri');
      tri.dataset.cell = `tri-${i}`;
      svg.appendChild(tri);
    }

    // 境界線（視認性向上・クリックには影響なし）
    const outline = document.createElementNS('http://www.w3.org/2000/svg','polygon');
    outline.setAttribute('points', outer.map(([x,y])=>`${x},${y}`).join(' '));
    outline.setAttribute('fill','none');
    outline.setAttribute('stroke','#aaa');
    outline.setAttribute('stroke-width','1.2');
    svg.appendChild(outline);
  }

  // SVG座標への変換
  function toSvgPoint(svgEl, clientX, clientY){
    const pt = svgEl.createSVGPoint();
    pt.x = clientX; pt.y = clientY;
    const ctm = svgEl.getScreenCTM();
    return pt.matrixTransform(ctm.inverse());
  }

  // クリック時のラベル配置（常に1つだけ）
  function placeLabelAt(x, y, text){
    // 既存を消す
    if (state.labelEl && state.labelEl.parentNode) {
      state.labelEl.parentNode.removeChild(state.labelEl);
    }
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', x);
    t.setAttribute('y', y);
    t.setAttribute('text-anchor','middle');
    t.setAttribute('dominant-baseline','middle');
    t.setAttribute('class','label');
    t.textContent = text;
    svg.appendChild(t);
    state.labelEl = t;
  }

  // --- イベント ---
  btnJoin.onclick = () => {
    state.name = normalizeName(nameInput.value);
    headerInfo.textContent = `あなた：${state.name}`;
    show(joinPanel, false);
    show(starPanel, true);
    if (!svg.hasChildNodes()) buildStar();
  };

  // 六芒星のセルだけ反応
  svg.addEventListener('click', (e)=>{
    const target = e.target;
    if (!(target instanceof SVGElement)) return;
    if (!target.classList.contains('cell')) return; // クリック対象のみ
    const p = toSvgPoint(svg, e.clientX, e.clientY);
    placeLabelAt(p.x, p.y, state.name || '？');
  });

  // URLパラメータで名前を事前入力（任意）
  try{
    const qs = new URLSearchParams(location.search);
    const qName = (qs.get('name')||'').trim();
    if (qName) nameInput.value = qName.slice(0,1);
  }catch(_e){}
</script>
</body>
</html>
