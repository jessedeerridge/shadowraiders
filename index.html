<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>シンプル・チャット（ルームコード式）</title>
<style>
  :root{ --maxw:880px; }
  *{ box-sizing:border-box; }
  body{
    margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans",
    "Noto Sans JP", "Yu Gothic UI", "Yu Gothic", "Meiryo", sans-serif;
    background:#0b0f14; color:#e6edf3;
    display:flex; min-height:100vh; align-items:center; justify-content:center;
  }
  .card{
    width:min(100%, var(--maxw)); background:#0f1722; border:1px solid #1f2a37;
    border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  h1{ font-size:20px; margin:0 0 16px; letter-spacing:.02em; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .field{ flex:1 1 200px; }
  label{ display:block; font-size:13px; color:#9fb0c0; margin:0 0 6px; }
  input{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid #243145;
    background:#0b121d; color:#e6edf3; outline:none;
  }
  input:focus{ border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.2); }
  button{
    padding:12px 16px; border-radius:12px; border:1px solid #2a3a54; cursor:pointer;
    background:#1b2a41; color:#e6edf3; font-weight:600;
  }
  button.primary{ background:#2563eb; border-color:#2563eb; }
  button:hover{ filter:brightness(1.05); }
  .hint{ font-size:12px; color:#7f93a8; margin-top:4px; }

  .hidden{ display:none !important; }

  /* chat area */
  .header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:10px 12px; border:1px solid #1f2a37; border-radius:12px; background:#0b121d;
    margin:8px 0 16px;
  }
  .pill{ padding:6px 10px; border:1px solid #2a3a54; border-radius:999px; font-size:12px; color:#b9c7d6; }
  .list{
    height:48vh; min-height:320px; overflow:auto; padding:12px; border:1px solid #1f2a37;
    border-radius:12px; background:#0b121d;
  }
  .msg{
    margin:0 0 10px; display:flex; gap:8px; align-items:flex-start;
  }
  .me .bubble{ background:#1f3b78; }
  .other .bubble{ background:#1d2636; }
  .bubble{
    max-width:75%; padding:10px 12px; border-radius:14px;
    white-space:pre-wrap; word-break:break-word; border:1px solid #2a3a54;
  }
  .meta{ font-size:11px; color:#8394a7; margin-top:4px; }
  .foot{
    display:flex; gap:8px; margin-top:10px;
  }
  .foot input{ flex:1; }
  .copy{ font-size:12px; }
</style>
</head>
<body>
  <div class="card" id="screen-join">
    <h1>チャットに入室</h1>
    <div class="row">
      <div class="field">
        <label for="name">名前（1文字：英字/漢字/ひらがな/カタカナ）</label>
        <input id="name" placeholder="例）A / 太 / あ / タ" maxlength="4" autocomplete="off" />
        <div class="hint">未入力ならランダム英字1文字が自動設定されます。</div>
      </div>
      <div class="field">
        <label for="code">ルームコード（4桁）</label>
        <input id="code" placeholder="例）0275（未入力なら自動生成）" inputmode="numeric" autocomplete="off" />
        <div class="hint">同じコードを入力した人は同じ部屋に入ります。</div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="primary" id="enter">入室</button>
    </div>
  </div>

  <div class="card hidden" id="screen-chat">
    <div class="header">
      <div>
        <div class="pill" id="room-pill">ROOM ----</div>
        <div class="hint" id="me-pill" style="margin-top:6px">あなた：-</div>
      </div>
      <div class="row" style="gap:6px">
        <button id="copy-code" class="copy">コードをコピー</button>
        <button id="leave">退出</button>
      </div>
    </div>
    <div id="messages" class="list" aria-live="polite"></div>
    <div class="foot">
      <input id="text" placeholder="メッセージを入力して Enter" />
      <button id="send" class="primary">送信</button>
    </div>
  </div>

  <!-- Firebase SDK (v10+ modular) -->
  <script type="module">
    // ================= Firebase 初期化 =================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, collection, addDoc,
      serverTimestamp, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASUJcPyybcD9q77XDatI5bCzZxDvsBH_o",
      authDomain: "shadowraiders-a2dbc.firebaseapp.com",
      projectId: "shadowraiders-a2dbc",
      storageBucket: "shadowraiders-a2dbc.firebasestorage.app",
      messagingSenderId: "577276689873",
      appId: "1:577276689873:web:9a13faf90c3d6a791e34f0",
      measurementId: "G-PKNEPDBVSS"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ================= ユーティリティ =================
    const $ = (sel) => document.querySelector(sel);
    const screenJoin = $("#screen-join");
    const screenChat = $("#screen-chat");
    const nameInput  = $("#name");
    const codeInput  = $("#code");
    const enterBtn   = $("#enter");
    const messagesEl = $("#messages");
    const textInput  = $("#text");
    const sendBtn    = $("#send");
    const roomPill   = $("#room-pill");
    const mePill     = $("#me-pill");

    // 端末ごとの簡易ID（匿名Auth不要）
    const clientId = (() => {
      const k = "chat-client-id";
      let v = localStorage.getItem(k);
      if(!v){ v = crypto.randomUUID(); localStorage.setItem(k, v); }
      return v;
    })();

    // 名前：1文字のみ許容（英字/ひらがな/カタカナ/漢字）。未入力なら英大文字1文字を付与
    function normalizeName(input){
      const s = (input || "").trim();
      let ch = null;
      for(const c of Array.from(s)){ // サロゲート対応で1コードポイントずつ
        if (/^[A-Za-z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]$/.test(c)) { ch = c; break; }
      }
      if(!ch){
        ch = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // 'A'〜'Z'
      }
      return ch;
    }

    // ルームコード：数字のみ4桁。未入力ならランダム4桁を生成
    function normalizeCode(input){
      const digits = String(input || "").replace(/\D/g, "");
      if(digits.length === 4) return digits;
      const rnd = Math.floor(Math.random() * 10000);
      return String(rnd).padStart(4, "0");
    }

    function scrollToBottom(){
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // ================= 入室処理 =================
    let roomRef = null;
    let unsubMessages = null;
    let myName = "-";
    let roomCode = "----";

    async function enterRoom(){
      myName   = normalizeName(nameInput.value);
      roomCode = normalizeCode(codeInput.value);

      // UI反映＆ローカル保存
      nameInput.value = myName;
      codeInput.value = roomCode;
      localStorage.setItem("lastName", myName);
      localStorage.setItem("lastCode", roomCode);

      // ルーム作成（なければ）／存在していれば参加
      roomRef = doc(db, "rooms", roomCode);
      const exists = (await getDoc(roomRef)).exists();
      await setDoc(roomRef, { createdAt: serverTimestamp() }, { merge: true });

      // メンバー登録（簡易）
      await setDoc(doc(db, "rooms", roomCode, "members", clientId), {
        name: myName,
        joinedAt: serverTimestamp()
      }, { merge: true });

      // 既に部屋があったのか、新規なのかシステムメッセージを軽く残す（任意）
      await addDoc(collection(db, "rooms", roomCode, "messages"), {
        text: exists ? `🔔 ${myName} さんが入室しました` : `🚪 ルーム ${roomCode} が作成されました（作成者：${myName}）`,
        name: "SYSTEM",
        createdAt: serverTimestamp()
      });

      // 画面切替
      screenJoin.classList.add("hidden");
      screenChat.classList.remove("hidden");
      roomPill.textContent = `ROOM ${roomCode}`;
      mePill.textContent   = `あなた：${myName}`;

      // メッセージ購読
      if (unsubMessages) unsubMessages();
      const q = query(collection(db, "rooms", roomCode, "messages"), orderBy("createdAt", "asc"));
      unsubMessages = onSnapshot(q, snap => {
        messagesEl.innerHTML = "";
        snap.forEach(docSnap => {
          const m = docSnap.data();
          const isMe = m.name === myName;
          const item = document.createElement("div");
          item.className = `msg ${isMe ? "me" : "other"}`;
          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.textContent = m.text || "";
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = (m.name || "匿名");
          const wrap = document.createElement("div");
          wrap.appendChild(bubble);
          wrap.appendChild(meta);
          item.appendChild(wrap);
          messagesEl.appendChild(item);
        });
        scrollToBottom();
      });

      textInput.focus();
    }

    async function sendMessage(){
      const text = textInput.value.trim();
      if(!text) return;
      await addDoc(collection(db, "rooms", roomCode, "messages"), {
        text, name: myName, createdAt: serverTimestamp()
      });
      textInput.value = "";
      textInput.focus();
    }

    // ================= イベント結線 =================
    // 前回の入力を復元
    const lastName = localStorage.getItem("lastName");
    const lastCode = localStorage.getItem("lastCode");
    if(lastName) nameInput.value = lastName;
    if(lastCode) codeInput.value = lastCode;

    enterBtn.addEventListener("click", enterRoom);
    codeInput.addEventListener("keydown", e => { if(e.key === "Enter") enterRoom(); });
    nameInput.addEventListener("keydown", e => { if(e.key === "Enter") enterRoom(); });

    sendBtn.addEventListener("click", sendMessage);
    textInput.addEventListener("keydown", e => { if(e.key === "Enter") sendMessage(); });

    $("#leave").addEventListener("click", () => {
      // 軽い退室ログ（任意）
      if (roomRef && roomCode && myName) {
        addDoc(collection(db, "rooms", roomCode, "messages"), {
          text:`👋 ${myName} さんが退出しました`, name:"SYSTEM", createdAt: serverTimestamp()
        });
      }
      // 画面戻す
      screenChat.classList.add("hidden");
      screenJoin.classList.remove("hidden");
      textInput.value = "";
      messagesEl.innerHTML = "";
      roomRef = null;
    });

    $("#copy-code").addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(roomCode);
        alert(`コード ${roomCode} をコピーしました`);
      }catch(_){ /* noop */ }
    });

    // タブを閉じる時に軽く記録（任意）
    window.addEventListener("beforeunload", () => {
      if(roomCode){
        addDoc(collection(db, "rooms", roomCode, "messages"), {
          text:`🚪 ${myName} さんが切断されました`, name:"SYSTEM", createdAt: serverTimestamp()
        });
      }
    });
  </script>

  <!--
    ■メモ
    - Firestore セキュリティルールは本番に合わせて必ず設定してください。
    - このサンプルは匿名認証を使わず、端末ごとの簡易IDでメンバー記録をしています。
    - 名前は 1 文字のみ（英字/漢字/ひらがな/カタカナ）。未入力時は英大文字 1 文字を自動付与。
    - ルームコードは 4 桁。未入力時は 0000〜9999 で自動生成。
    - 同じコードの人は同じ rooms/{code} に接続し、messages サブコレクションを共有します。
  -->
</body>
</html>
